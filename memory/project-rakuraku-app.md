# 案件管理アプリ（楽楽販売の代替）

## 概要
楽楽販売のいいところどりをした案件管理Webアプリ制作。会社全体（エイチームグループ）で利用。

## チャンネル
- 壁打ち開始: #openclaw-home (2026-02-12)
- 専用チャンネル: #楽楽販売ライクアプリ制作 (1471511380426489959)

## 技術構成（確定 2026-02-14）
- **ホスティング**: Vercel + Supabase（無料枠でデモ→OK後に有料プラン月¥7,000程度）
- **認証**: ID/パスワード認証（Supabase Auth）
- **セキュリティ**: ISMSベースで設計、データ国内保持（Tokyo リージョン）、RLS全テーブル対応
- **比較**: 楽楽販売 月6万〜 → 本アプリ 月¥7,000〜（1/8以下）
- **マイグレーション**: 
  - 001_initial.sql（基本テーブル・RLS・初期データ）
  - 002_project_categories.sql（カテゴリマスタ）
  - 003_multi_role_teams.sql（3役割担当・チーム管理）
  - 004_invoice_delivery.sql（請求書送付方法・ステータス）

## フェーズ計画
- **Phase 1（1週間）**: コア機能（SSO認証・権限・案件CRUD・ツリー表示・見積もり/検収書/請求書・承認フロー・クラウドサイン連携・メール送信・操作ログ）
- **Phase 2（+数日）**: 売上ダッシュボード・テンプレート設定・CSV・データ移行

## 確定要件

### 認証・権限
- ID/パスワード認証
- 権限: 管理者 / 承認者（マネージャー） / 一般
- 売上表示の出し分け: 一般=自分のみ / 承認者=チーム+全体 / 管理者=全体

### 承認フロー
- 見積もり・検収書・請求書すべて要承認
- 金額条件で分岐（例: 100万以下→マネージャー、超→部長）
- 金額閾値は管理者が設定可能
- 承認依頼のメール通知あり

### クライアントマスタ
- 会社名、部署名、担当者名、メールアドレス、電話番号、郵便番号・住所、クラウドサイン用メールアドレス、備考
- 検索式（インクリメンタルサーチ）で選択

### 案件
- 案件番号（自動連番）
- 案件名、クライアント（マスタから検索選択）、担当営業マン
- 案件ステータス（見積もり中 / 受注 / 検収済 / 請求済 / 完了）
- 受注金額、売上計上予定月
- **案件期間**: 開始月〜終了月（単月も長期も対応）
- 長期案件 = その期間毎月請求発生
- 案件カテゴリ、備考
- 月MAX 500案件、1案件 = 1見積もり

### 見積もり
- 見積もり番号（自動連番）
- 宛先（クライアントマスタから自動）、件名
- 明細行（品目・数量・単価・金額）、小計・消費税・合計
- 見積もり有効期限、備考
- 承認ステータス
- **プレビュー機能**（PDF風表示→そのまま送信）

### 検収書
- 検収書番号（自動連番）
- 紐づく案件・見積もり（自動）
- 検収日、明細（見積もりからコピー）、合計金額、備考
- 承認ステータス、クラウドサイン送信ステータス
- プレビュー
- **作成条件**: クラウドサイン締結完了 + 担当者が「納品完了」ボタン押下 → 両方揃って初めて作成可能

### 請求書
- 請求書番号（自動連番）
- 紐づく案件（自動）、クライアント情報（自動）
- 請求日、支払期限（デフォルト翌月末）
- 振込先口座（1つ、設定画面で登録）
- 明細、小計・消費税・合計
- 請求対象月（長期案件用）
- **入金ステータス**（未入金 / 入金済）→ 消込あり
- 備考、承認ステータス、プレビュー
- **長期案件**: 毎月自動ドラフト生成 + 手動修正可

### 支払条件
- 売掛（翌月末）/ 前金 → 案件 or クライアント単位で選択
- **前金フロー**: 見積もり承認→クラウドサイン締結→前金請求書発行→入金確認→作業開始→納品完了→検収書→（残金あれば）売掛請求書

### 売上
- 計上タイミング: 検収書受領時
- 営業マンごと月次売上、部署ごと集計
- CSVダウンロード
- 上期(8〜1月)/下期(2〜7月)区切り + 過去分すべて参照可能
- 売上詳細項目（計上予定月、案件内容等）→ 別途詰める

### 業務フロー（ステータス遷移）
```
案件作成 → 見積もり作成 → 見積もり承認 → クラウドサイン送信
→ クラウドサイン締結完了 → [前金の場合: 前金請求書→入金確認]
→ 作業開始 → 納品完了（自己申告ボタン） → 検収書作成可能
→ 検収書承認 → 請求書作成 → 請求書承認 → 送信 → 入金確認
```

### 紐づけ（ツリー構造）
- 書類は必ず案件の中から作成（単体作成不可）→ 紐づけミスが構造的にゼロ
- ツリー表示で案件→見積もり→検収書→請求書が一目でわかる
- 一覧は案件名+クライアント名を常に表示（番号はサブ情報）

### クラウドサイン・送付方法
- **クラウドサイン使用**: 見積もり申し込み、検収のみ
- **請求書**: メール送信 or PDFダウンロード→個別送信（クラウドサインは使わない）
- 個別送信の場合「送信済み」ボタンで記録（送付忘れ防止）

### その他機能
- アプリ内メール送信
- クラウドサイン連携（API）※見積もり・検収のみ
- 書類テンプレート設定（既存テンプレを登録）
- 操作ログ（誰がいつ何をしたか）
- データ移行（楽楽販売から）
- 一覧フィルタ: 案件名/クライアント名検索、ステータス、担当者、期間、入金ステータス

### UI/UX方針
- **「説明書なしで使える」がゴール**
- 新人が初めて見てもすぐわかるUI

## 待ちリスト
- [ ] 書類テンプレート（見積もり・検収書・請求書）→ かっぴーから送付
- [ ] クラウドサインAPIキー → かっぴーが社内確認
- [ ] 売上の細かい項目（計上予定月以外）

## 優先順位（かっぴー確定 2026-02-14）
1. **セキュリティ** ← 最優先。ここがダメなら絶対OK出ない（クライアント情報・NDA関連）
2. **使い勝手（UI/UX）**

## 完了物
- 書類テンプレートサンプル: `rakuraku-app/templates/`（見積書・請求書・検収書）

## 完了済み
- Phase 1 開発（全31ファイル）
- Supabase クラウドDB構築（プロジェクトID: cumvmmiypkybmxumtuhm）
- Vercel デプロイ: https://rakuraku-app.vercel.app
- テストユーザー3種（admin/manager/user）+ サンプルクライアント3社
- モバイル対応（ハンバーガーメニュー、レスポンシブレイアウト）
- UI改善7項目（受注金額、ログアウト見切れ、カテゴリプルダウン等）
- ダッシュボード（当月サマリー、未回収件数、権限別表示、フィルタ遷移）
- カテゴリマスタ管理（管理者画面でCRUD可能）
- 継続案件の計上月対応（開始〜終了月の全月表示）
- **3役割担当者機能**（フロント・MS・CR、任意選択）
- **チーム管理機能**（設定画面でチームCRUD、部署別）
- 権限別表示範囲（管理者=全体、承認者=チーム、一般=自分）
- **請求書送付機能**（メール送信 or PDF手動送信、送付ステータス記録）
- **ダッシュボード未回収フィルタ**（正確な条件で案件一覧遷移）
- **リファクタリング**（共通フック・ロジック、13ファイル統一、並列クエリ化）

## 運用・保守要件（Phase 2以降）
- コード管理: GitHubリポジトリ作成・プッシュ
- DBバックアップ: Supabase有料プラン or 定期手動エクスポート（cron自動化）
- 監視: Vercel Analytics + Supabase監視
- ドキュメント: 環境変数一覧、セットアップ手順、障害復旧手順、連絡先

## 次のアクション（2026-02-15）
1. 加藤様による動作確認・フィードバック
2. UI/機能改善
3. Phase 2（売上ダッシュボード・テンプレート設定・CSV・データ移行）
4. 運用・保守体制整備

---
*作成: 2026-02-12*
*最終更新: 2026-02-15*
